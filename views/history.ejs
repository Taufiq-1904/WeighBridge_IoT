<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>

  <!-- Load CSS Global -->
  <link rel="stylesheet" href="/css/main.css" />
  <!-- Load CSS Khusus Halaman Ini -->
  <link rel="stylesheet" href="/css/history.css" />
  
  <!-- Chart.js dari CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <!-- Navbar/Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <h1>âš–ï¸ WeighBridge IoT</h1>
        </div>
        <nav class="navbar">
          <a href="/" class="nav-link">Dashboard</a>
          <a href="/history" class="nav-link active">History</a>
          <a href="/control" class="nav-link">Control</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="history-container">
        <!-- Header Section -->
        <section class="history-header">
          <h2>ğŸ“Š Riwayat Timbangan</h2>
          <div class="header-actions">
            <button id="exportBtn" class="btn btn-secondary">ğŸ“¥ Export CSV</button>
            <button id="refreshBtn" class="btn btn-primary">ğŸ”„ Refresh</button>
          </div>
        </section>

        <!-- Filter Section -->
        <section class="filter-section">
          <div class="filter-group">
            <label for="filterDate">Filter Tanggal:</label>
            <input type="date" id="filterDate" class="input-field" />
          </div>
          <div class="filter-group">
            <label for="filterWeight">Filter Berat (g):</label>
            <input type="number" id="filterWeight" class="input-field" placeholder="Min berat" />
          </div>
          <button id="clearFilterBtn" class="btn btn-outline">âŒ Clear Filter</button>
        </section>

        <!-- Chart Card -->
        <section class="chart-card">
          <h3>Grafik Berat Timbangan (7 Hari Terakhir)</h3>
          <canvas id="historyChart"></canvas>
        </section>

        <!-- Table Section -->
        <section class="table-section">
          <h3>Data Tabel Lengkap</h3>
          <div class="table-wrapper">
            <% if (rows && rows.length > 0) { %>
              <table class="history-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>ID Kendaraan</th>
                    <th>Berat (g)</th>
                    <th>Waktu</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <% rows.forEach((item, index) => { %>
                    <tr>
                      <td><%= index + 1 %></td>
                      <td><strong><%= item.id || '-' %></strong></td>
                      <td><%= item.weight || '-' %></td>
                      <td><%= new Date(item.created_at).toLocaleString('id-ID') %></td>
                      <td>
                        <button class="btn-small btn-delete" data-id="<%= item.id != null ? item.id : '' %>" onclick="deleteRecord(this.dataset.id)">ğŸ—‘ï¸ Hapus</button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            <% } else { %>
              <div class="empty-state">
                <p>ğŸ“­ Tidak ada data riwayat timbangan</p>
              </div>
            <% } %>
          </div>
        </section>

        <!-- Pagination -->
        <section class="pagination">
          <button class="btn btn-outline" onclick="previousPage()">â† Sebelumnya</button>
          <span id="pageInfo">Halaman 1</span>
          <button class="btn btn-outline" onclick="nextPage()">Selanjutnya â†’</button>
        </section>
      </div>
    </main>
  <!-- Script -->
  <script src="/js/history.js"></script>
<script>
  // Ambil data dari backend
  let historyData = JSON.parse('<%- JSON.stringify(rows || []) %>');

  // XSS Prevention - Escape HTML
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
  }

  // Chart.js instance
  let historyChart = null;

  function initChart(data = historyData) {
    const ctx = document.getElementById('historyChart');
    if (!ctx) return;

    const labels = data.map(item =>
      new Date(item.created_at).toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit' })
    );
    const chartValues = data.map(item => item.weight);

    const chartConfig = {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Berat Timbangan (Kg)',
          data: chartValues,
          borderColor: '#4a69bd',
          backgroundColor: 'rgba(74, 105, 189, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointBackgroundColor: '#4a69bd',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: true, position: 'top' } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Berat (Kg)' } }
        }
      }
    };

    if (historyChart) {
      historyChart.destroy(); // hapus chart lama sebelum update
    }

    historyChart = new Chart(ctx, chartConfig);
  }

  // FILTER
  function applyFilters() {
    const dateFilter = document.getElementById('filterDate').value;
    const weightFilter = parseFloat(document.getElementById('filterWeight').value);

    const filtered = historyData.filter(item => {
      let valid = true;
      if (dateFilter) {
        const itemDate = new Date(item.created_at).toISOString().slice(0, 10);
        valid = valid && itemDate === dateFilter;
      }
      if (!isNaN(weightFilter)) {
        valid = valid && item.weight >= weightFilter;
      }
      return valid;
    });

    renderTable(filtered);
    initChart(filtered);
  }

  function clearFilters() {
    document.getElementById('filterDate').value = '';
    document.getElementById('filterWeight').value = '';
    renderTable(historyData);
    initChart(historyData);
  }

  // TABEL
  function renderTable(data) {
    const tbody = document.querySelector('.history-table tbody');
    if (!tbody) return;

    tbody.innerHTML = '';
    data.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${escapeHtml(item.id || '-')}</td>
        <td>${escapeHtml(item.weight || '-')}</td>
        <td>${new Date(item.created_at).toLocaleString('id-ID')}</td>
        <td><button class="btn-small btn-delete" onclick="deleteRecord('${item.id}')">ğŸ—‘ï¸ Hapus</button></td>
      `;
      tbody.appendChild(row);
    });

    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">ğŸ“­ Tidak ada data</td></tr>`;
    }
  }

  // DELETE RECORD
  function deleteRecord(id) {
    if (!confirm('Apakah yakin ingin menghapus data ini?')) return;

    fetch(`/api/history/${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    }).then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Data berhasil dihapus');
          historyData = historyData.filter(item => item.id != id);
          renderTable(historyData);
          initChart(historyData);
        } else {
          alert('Gagal menghapus data: ' + (data.message || 'Unknown error'));
        }
      }).catch(err => {
        console.error(err);
        alert('Terjadi kesalahan');
      });
  }

  // EXPORT CSV
  function exportToCSV() {
    const rows = [['No','ID Kendaraan','Berat (g)','Waktu']];
    historyData.forEach((item, index) => {
      rows.push([index+1, item.id, item.weight, new Date(item.created_at).toLocaleString('id-ID')]);
    });
    const csvContent = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `history_${new Date().getTime()}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  }

  // EVENT LISTENER
  document.getElementById('filterDate')?.addEventListener('change', applyFilters);
  document.getElementById('filterWeight')?.addEventListener('input', applyFilters);
  document.getElementById('clearFilterBtn')?.addEventListener('click', clearFilters);
  document.getElementById('exportBtn')?.addEventListener('click', exportToCSV);
  document.getElementById('refreshBtn')?.addEventListener('click', () => location.reload());

  // INIT
  document.addEventListener('DOMContentLoaded', () => {
    renderTable(historyData);
    initChart(historyData);
  });
</script>

</body>
</html>